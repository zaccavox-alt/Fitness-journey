<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Our Fitness Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- PWA bits -->
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top left, #1e293b, #020617);
      color: #e5e7eb;
      padding: 1rem;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 1.5rem;
      padding: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.1);
      color: #6ee7b7;
      font-size: 0.75rem;
      border: 1px solid rgba(45, 212, 191, 0.4);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 6px #22c55e;
    }

    .user-toggle {
      display: inline-flex;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 0.25rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .user-toggle button {
      border: none;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      background: transparent;
      color: #9ca3af;
      transition: all 0.16s ease-out;
      white-space: nowrap;
    }

    .user-toggle button.active {
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.7);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 1.25rem;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.4), rgba(15, 23, 42, 0.96));
      border-radius: 1.25rem;
      padding: 1.1rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .card small {
      color: #9ca3af;
      font-size: 0.8rem;
    }

    .goals-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.8rem;
      margin-bottom: 0.6rem;
      flex-wrap: wrap;
    }

    .goal-pill {
      flex: 1;
      min-width: 120px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 0.9rem;
      padding: 0.7rem 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.8rem;
    }

    .goal-label {
      color: #9ca3af;
      font-size: 0.75rem;
    }

    .goal-value {
      font-size: 0.95rem;
      margin-top: 0.15rem;
      font-weight: 600;
    }

    form {
      margin-top: 0.75rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem 0.75rem;
      font-size: 0.85rem;
    }

    @media (max-width: 600px) {
      form {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    input, textarea, select {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.4rem 0.65rem;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }

    .form-full {
      grid-column: 1 / -1;
    }

    .btn-primary {
      grid-column: 1 / -1;
      margin-top: 0.3rem;
      padding: 0.55rem 0.8rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.7);
    }

    .btn-small {
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .btn-small:hover {
      background: rgba(30, 64, 175, 0.8);
    }

    .btn-icon {
      border: none;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.85rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .btn-icon:hover {
      background: rgba(127, 29, 29, 0.9);
      border-color: rgba(248, 113, 113, 0.9);
    }

    .summary-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.8rem;
      flex-wrap: wrap;
    }

    .summary-heading {
      margin-top: 0.6rem;
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .chip {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }

    .charts {
      margin-top: 0.7rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }

    @media (max-width: 800px) {
      .charts {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .chart-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 0.5rem 0.6rem 0.8rem;
    }

    .chart-card-title {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.25rem;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 160px;
    }

    .entries-list {
      margin-top: 0.7rem;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      z-index: 1;
    }

    th, td {
      padding: 0.45rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    th {
      color: #9ca3af;
      font-weight: 500;
      font-size: 0.75rem;
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.96);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }

    .note-cell {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .empty-state {
      padding: 0.8rem;
      text-align: center;
      color: #6b7280;
      font-size: 0.8rem;
    }

    /* Encouragement board */

    .encouragement {
      margin-top: 0.9rem;
      padding-top: 0.7rem;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .enc-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
    }

    .enc-header h3 {
      font-size: 0.95rem;
    }

    .enc-header small {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    #encForm {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    #encForm textarea {
      min-height: 44px;
      max-height: 100px;
      font-size: 0.8rem;
    }

    #encForm button {
      align-self: flex-start;
      padding-inline: 0.9rem;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .enc-list {
      max-height: 140px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .enc-item {
      padding: 0.5rem 0.6rem;
      border-radius: 0.7rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .enc-meta {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      font-size: 0.7rem;
      color: #9ca3af;
      margin-bottom: 0.2rem;
    }

    .enc-text {
      font-size: 0.8rem;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Our Fitness Journey</h1>
        <p class="subtitle">Log workouts, chase goals, and keep each other accountable. üíö</p>
      </div>
      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:0.35rem;">
        <div class="pill">
          <span class="pill-dot"></span>
          Shared Progress
        </div>
        <div class="user-toggle" id="userToggle">
          <button data-user="you" class="active">You</button>
          <button data-user="partner">Partner</button>
        </div>
        <button id="editNamesBtn" class="btn-small" type="button">
          ‚úèÔ∏è Edit names
        </button>
      </div>
    </header>

    <div class="layout">
      <!-- Left: goals + log -->
      <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
          <div>
            <h2 id="goalsTitle">Weekly goals</h2>
            <small>Simple weekly targets you‚Äôre both aiming for.</small>
          </div>
          <button id="editGoalsBtn" class="btn-small" type="button">
            ‚úèÔ∏è Edit goals
          </button>
        </div>

        <div class="goals-row" id="goalsDisplay">
          <!-- Filled by JS -->
        </div>

        <form id="goalsForm" style="display:none; margin-bottom:0.6rem;">
          <label>
            Workouts / week
            <input type="number" min="0" id="goalWorkouts" placeholder="e.g. 4" />
          </label>
          <label>
            Active minutes / week
            <input type="number" min="0" id="goalMinutes" placeholder="e.g. 150" />
          </label>
          <button type="button" class="btn-primary" id="saveGoalsBtn">
            üíæ Save goals
          </button>
        </form>

        <hr style="border:none; border-top:1px solid rgba(31,41,55,0.9); margin:0.5rem 0 0.8rem;" />

        <div>
          <h2>Log today</h2>
          <small>Add your workout or activity for any day.</small>
        </div>

        <form id="logForm">
          <label>
            Date
            <input type="date" id="logDate" required />
          </label>

          <label>
            Workouts
            <input type="number" min="0" id="logWorkouts" placeholder="e.g. 1" />
          </label>

          <label>
            Active minutes
            <input type="number" min="0" id="logMinutes" placeholder="e.g. 45" />
          </label>

          <label>
            Steps (optional)
            <input type="number" min="0" id="logSteps" placeholder="e.g. 8000" />
          </label>

          <label class="form-full">
            Notes (how did it feel?)
            <textarea id="logNotes" placeholder="Felt strong, hit a new PR, went for a walk together..."></textarea>
          </label>

          <button type="submit" class="btn-primary">
            ‚ûï Add entry
          </button>
        </form>
      </section>

      <!-- Right: summary + charts + history + encouragement -->
      <section class="card">
        <div>
          <h2 id="summaryTitle">This week</h2>
          <small>Last 7 days for the selected person.</small>
        </div>

        <div class="summary-row" id="summaryChips">
          <!-- Filled by JS -->
        </div>

        <div class="summary-heading">Couple summary (last 7 days)</div>
        <div class="summary-row" id="coupleSummaryRow">
          <!-- Filled by JS -->
        </div>

        <div class="charts">
          <div class="chart-card">
            <div class="chart-card-title">Workouts (last 7 days)</div>
            <div class="chart-wrapper">
              <canvas id="workoutsChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-card-title">Active minutes (last 7 days)</div>
            <div class="chart-wrapper">
              <canvas id="minutesChart"></canvas>
            </div>
          </div>
        </div>

        <div class="entries-list" id="entriesContainer">
          <!-- Table inserted by JS -->
        </div>

        <div class="encouragement">
          <div class="enc-header">
            <h3>Encouragement board</h3>
            <small>Leave little notes to cheer each other on.</small>
          </div>
          <form id="encForm">
            <textarea
              id="encText"
              placeholder="e.g. Proud of you for staying consistent this week ‚ù§Ô∏è"
            ></textarea>
            <button type="submit" class="btn-primary">
              üíå Add note
            </button>
          </form>
          <div class="enc-list" id="encList">
            <!-- Encouragement messages -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const APP_KEY = "couple_fitness_v1";

    const defaultState = {
      activeUser: "you",
      users: {
        you: {
          label: "You",
          goals: {
            workoutsPerWeek: 3,
            minutesPerWeek: 120,
          },
          entries: [],
        },
        partner: {
          label: "Partner",
          goals: {
            workoutsPerWeek: 3,
            minutesPerWeek: 120,
          },
          entries: [],
        },
      },
      messages: [],
    };

    function generateEntryId() {
      return (
        Date.now().toString(36) +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function ensureUserShape(stateObj, key, fallbackLabel) {
      if (!stateObj.users[key]) {
        stateObj.users[key] = {
          label: fallbackLabel,
          goals: { workoutsPerWeek: 3, minutesPerWeek: 120 },
          entries: [],
        };
      } else {
        const user = stateObj.users[key];
        if (typeof user.label !== "string" || !user.label.trim()) {
          user.label = fallbackLabel;
        }
        if (!user.goals) {
          user.goals = { workoutsPerWeek: 3, minutesPerWeek: 120 };
        }
        if (!Array.isArray(user.entries)) {
          user.entries = [];
        }
      }
    }

    function addMissingEntryIdsAndLabels(stateObj) {
      ensureUserShape(stateObj, "you", "You");
      ensureUserShape(stateObj, "partner", "Partner");

      ["you", "partner"].forEach((key) => {
        const user = stateObj.users[key];
        user.entries.forEach((entry) => {
          if (!entry.id) {
            entry.id = generateEntryId();
          }
        });
      });

      if (!Array.isArray(stateObj.messages)) {
        stateObj.messages = [];
      }
    }

    function loadState() {
      try {
        const stored = localStorage.getItem(APP_KEY);
        if (!stored) {
          const clone = structuredClone(defaultState);
          addMissingEntryIdsAndLabels(clone);
          return clone;
        }
        const parsed = JSON.parse(stored);
        if (!parsed.users) {
          parsed.users = {};
        }
        if (!parsed.messages) parsed.messages = [];
        addMissingEntryIdsAndLabels(parsed);
        return parsed;
      } catch (e) {
        console.error("Failed to load state", e);
        const clone = structuredClone(defaultState);
        addMissingEntryIdsAndLabels(clone);
        return clone;
      }
    }

    let state = loadState();

    function saveState() {
      localStorage.setItem(APP_KEY, JSON.stringify(state));
    }

    function getActiveUserKey() {
      return state.activeUser;
    }

    function getActiveUser() {
      return state.users[getActiveUserKey()];
    }

    function formatDate(dateStr) {
      const options = { month: "short", day: "numeric" };
      const d = new Date(dateStr + "T00:00:00");
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString(undefined, options);
    }

    function formatDateTimeShort(isoString) {
      const d = new Date(isoString);
      if (isNaN(d)) return "";
      const date = d.toLocaleDateString(undefined, {
        month: "short",
        day: "numeric",
      });
      const time = d.toLocaleTimeString(undefined, {
        hour: "numeric",
        minute: "2-digit",
      });
      return `${date}, ${time}`;
    }

    function renderUserToggle() {
      const toggle = document.getElementById("userToggle");
      toggle.querySelectorAll("button").forEach((btn) => {
        const key = btn.getAttribute("data-user");
        const isActive = key === getActiveUserKey();
        btn.classList.toggle("active", isActive);
        const user = state.users[key];
        btn.textContent = user ? user.label : key;
      });
    }

    function renderGoals() {
      const user = getActiveUser();
      const container = document.getElementById("goalsDisplay");
      const goalsTitle = document.getElementById("goalsTitle");

      goalsTitle.textContent = `${user.label}'s weekly goals`;

      container.innerHTML = `
        <div class="goal-pill">
          <div class="goal-label">Workouts / week</div>
          <div class="goal-value">${user.goals.workoutsPerWeek || 0}</div>
        </div>
        <div class="goal-pill">
          <div class="goal-label">Active minutes / week</div>
          <div class="goal-value">${user.goals.minutesPerWeek || 0} min</div>
        </div>
      `;

      document.getElementById("goalWorkouts").value =
        user.goals.workoutsPerWeek ?? "";
      document.getElementById("goalMinutes").value =
        user.goals.minutesPerWeek ?? "";
    }

    function getLast7DayTotals(user) {
      const entries = user.entries || [];
      const now = new Date();
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(now.getDate() - 6); // include today

      let totalWorkouts = 0;
      let totalMinutes = 0;
      let daysLogged = new Set();

      entries.forEach((entry) => {
        if (!entry.date) return;
        const d = new Date(entry.date + "T00:00:00");
        if (isNaN(d)) return;
        if (d >= sevenDaysAgo && d <= now) {
          totalWorkouts += Number(entry.workouts || 0);
          totalMinutes += Number(entry.minutes || 0);
          daysLogged.add(entry.date);
        }
      });

      return {
        workouts: totalWorkouts,
        minutes: totalMinutes,
        days: daysLogged.size,
      };
    }

    function getLast7DaySeries(user) {
      const entries = user.entries || [];
      const now = new Date();
      const days = [];

      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const key = `${yyyy}-${mm}-${dd}`;
        const label = d.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
        });
        days.push({ key, label });
      }

      const workouts = days.map((day) => {
        return entries
          .filter((e) => e.date === day.key)
          .reduce((sum, e) => sum + Number(e.workouts || 0), 0);
      });

      const minutes = days.map((day) => {
        return entries
          .filter((e) => e.date === day.key)
          .reduce((sum, e) => sum + Number(e.minutes || 0), 0);
      });

      return {
        labels: days.map((d) => d.label),
        workouts,
        minutes,
      };
    }

    function renderSummary() {
      const user = getActiveUser();
      const summaryTitle = document.getElementById("summaryTitle");
      summaryTitle.textContent = `${user.label}'s last 7 days`;

      const chipsContainer = document.getElementById("summaryChips");

      const activeTotals = getLast7DayTotals(user);
      const workoutsGoal = user.goals.workoutsPerWeek || 0;
      const minutesGoal = user.goals.minutesPerWeek || 0;

      chipsContainer.innerHTML = `
        <div class="chip">
          <span class="chip-dot"></span>
          ${activeTotals.workouts} / ${workoutsGoal} workouts
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          ${activeTotals.minutes} / ${minutesGoal} min
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          Logged on ${activeTotals.days} / 7 days
        </div>
      `;

      const coupleRow = document.getElementById("coupleSummaryRow");
      const youTotals = getLast7DayTotals(state.users.you);
      const partnerTotals = getLast7DayTotals(state.users.partner);
      const coupleWorkouts = youTotals.workouts + partnerTotals.workouts;
      const coupleMinutes = youTotals.minutes + partnerTotals.minutes;

      coupleRow.innerHTML = `
        <div class="chip">
          <span class="chip-dot"></span>
          ${state.users.you.label}: ${youTotals.workouts} w, ${youTotals.minutes} min
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          ${state.users.partner.label}: ${partnerTotals.workouts} w, ${partnerTotals.minutes} min
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          Together: ${coupleWorkouts} w, ${coupleMinutes} min
        </div>
      `;
    }

    function renderEntries() {
      const user = getActiveUser();
      const container = document.getElementById("entriesContainer");
      const entries = [...(user.entries || [])];

      entries.sort((a, b) => {
        const da = new Date(a.date + "T00:00:00");
        const db = new Date(b.date + "T00:00:00");
        return db - da;
      });

      if (entries.length === 0) {
        container.innerHTML = `<div class="empty-state">
          No entries yet. Log your first workout and start your streak together. ‚ú®
        </div>`;
        return;
      }

      let rows = entries
        .map((e) => {
          const date = formatDate(e.date);
          const workouts = e.workouts || 0;
          const minutes = e.minutes || 0;
          const steps = e.steps ?? "";
          const notes = e.notes || "";
          const safeTitle = String(notes).replace(/"/g, "&quot;");
          return `
          <tr>
            <td>${date}</td>
            <td>${workouts}</td>
            <td>${minutes}</td>
            <td>${steps === null ? "" : steps}</td>
            <td class="note-cell" title="${safeTitle}">
              ${notes || "<span style='color:#6b7280;'>‚Äî</span>"}
            </td>
            <td style="text-align:right;">
              <button type="button" class="btn-icon" data-entry-id="${e.id}">
                üóë
              </button>
            </td>
          </tr>
        `;
        })
        .join("");

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width:70px;">Date</th>
              <th style="width:60px;">Workouts</th>
              <th style="width:80px;">Minutes</th>
              <th style="width:80px;">Steps</th>
              <th>Notes</th>
              <th style="width:40px;"></th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    let workoutsChart = null;
    let minutesChart = null;

    function renderCharts() {
      const user = getActiveUser();
      const series = getLast7DaySeries(user);
      const workoutsCtx = document
        .getElementById("workoutsChart")
        .getContext("2d");
      const minutesCtx = document
        .getElementById("minutesChart")
        .getContext("2d");

      if (workoutsChart) {
        workoutsChart.destroy();
      }
      if (minutesChart) {
        minutesChart.destroy();
      }

      workoutsChart = new Chart(workoutsCtx, {
        type: "bar",
        data: {
          labels: series.labels,
          datasets: [
            {
              label: "Workouts",
              data: series.workouts,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
          },
        },
      });

      minutesChart = new Chart(minutesCtx, {
        type: "bar",
        data: {
          labels: series.labels,
          datasets: [
            {
              label: "Minutes",
              data: series.minutes,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
            },
          },
          plugins: {
            legend: {
              display: false,
            },
          },
        },
      });
    }

    function renderEncouragement() {
      const listEl = document.getElementById("encList");
      const messages = [...(state.messages || [])];

      if (messages.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state" style="padding:0.5rem 0; font-size:0.78rem;">
            No notes yet. Leave a kind word for each other. üíå
          </div>
        `;
        return;
      }

      messages.sort((a, b) => {
        const da = new Date(a.createdAt);
        const db = new Date(b.createdAt);
        return db - da; // newest first
      });

      const items = messages
        .map((m) => {
          const user = state.users[m.author] || { label: m.author };
          const when = formatDateTimeShort(m.createdAt);
          const text = (m.text || "").trim();
          const safeText = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
          return `
            <div class="enc-item">
              <div class="enc-meta">
                <span>${user.label}</span>
                <span>${when}</span>
              </div>
              <div class="enc-text">${safeText}</div>
            </div>
          `;
        })
        .join("");

      listEl.innerHTML = items;
    }

    function renderAll() {
      renderUserToggle();
      renderGoals();
      renderSummary();
      renderEntries();
      renderCharts();
      renderEncouragement();
    }

    function setupUserToggle() {
      const toggle = document.getElementById("userToggle");
      toggle.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-user]");
        if (!btn) return;
        const userKey = btn.getAttribute("data-user");
        if (!state.users[userKey]) return;
        state.activeUser = userKey;
        saveState();
        renderAll();
      });
    }

    function setupGoalsEditing() {
      const editBtn = document.getElementById("editGoalsBtn");
      const goalsForm = document.getElementById("goalsForm");
      const saveBtn = document.getElementById("saveGoalsBtn");

      editBtn.addEventListener("click", () => {
        const visible = goalsForm.style.display === "grid";
        goalsForm.style.display = visible ? "none" : "grid";
      });

      saveBtn.addEventListener("click", () => {
        const workouts = Number(
          document.getElementById("goalWorkouts").value || 0
        );
        const minutes = Number(
          document.getElementById("goalMinutes").value || 0
        );

        const user = getActiveUser();
        user.goals.workoutsPerWeek = Math.max(0, Math.floor(workouts));
        user.goals.minutesPerWeek = Math.max(0, Math.floor(minutes));

        saveState();
        renderGoals();
        renderSummary();
        renderCharts();
      });
    }

    function setupLogForm() {
      const form = document.getElementById("logForm");
      const dateInput = document.getElementById("logDate");

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const date = dateInput.value;
        if (!date) return;

        const workouts = Number(
          document.getElementById("logWorkouts").value || 0
        );
        const minutes = Number(
          document.getElementById("logMinutes").value || 0
        );
        const stepsRaw = document.getElementById("logSteps").value.trim();
        const notes = document.getElementById("logNotes").value.trim();

        const user = getActiveUser();
        user.entries.push({
          id: generateEntryId(),
          date,
          workouts,
          minutes,
          steps: stepsRaw === "" ? null : Number(stepsRaw),
          notes,
        });

        saveState();
        renderSummary();
        renderEntries();
        renderCharts();

        document.getElementById("logWorkouts").value = "";
        document.getElementById("logMinutes").value = "";
        document.getElementById("logSteps").value = "";
        document.getElementById("logNotes").value = "";
      });
    }

    function setupDeleteHandler() {
      const container = document.getElementById("entriesContainer");
      container.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-entry-id]");
        if (!btn) return;
        const id = btn.getAttribute("data-entry-id");
        const user = getActiveUser();
        const idx = user.entries.findIndex((entry) => entry.id === id);
        if (idx === -1) return;

        const confirmed = window.confirm("Delete this entry?");
        if (!confirmed) return;

        user.entries.splice(idx, 1);
        saveState();
        renderSummary();
        renderEntries();
        renderCharts();
      });
    }

    function setupEncouragementForm() {
      const form = document.getElementById("encForm");
      const textarea = document.getElementById("encText");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = textarea.value.trim();
        if (!text) return;

        const authorKey = getActiveUserKey();
        state.messages.push({
          id: generateEntryId(),
          author: authorKey,
          text,
          createdAt: new Date().toISOString(),
        });

        saveState();
        textarea.value = "";
        renderEncouragement();
      });
    }

    function setupEditNames() {
      const btn = document.getElementById("editNamesBtn");
      btn.addEventListener("click", () => {
        const currentYou = state.users.you.label || "You";
        const currentPartner = state.users.partner.label || "Partner";

        const youName = window.prompt("Enter your name:", currentYou);
        if (youName !== null && youName.trim() !== "") {
          state.users.you.label = youName.trim();
        }

        const partnerName = window.prompt(
          "Enter your partner's name:",
          currentPartner
        );
        if (partnerName !== null && partnerName.trim() !== "") {
          state.users.partner.label = partnerName.trim();
        }

        saveState();
        renderAll();
      });
    }

    // Register service worker for PWA
    function setupServiceWorker() {
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("service-worker.js")
            .catch((err) => console.error("SW registration failed", err));
        });
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupUserToggle();
      setupGoalsEditing();
      setupLogForm();
      setupDeleteHandler();
      setupEncouragementForm();
      setupEditNames();
      setupServiceWorker();
      renderAll();
    });
  </script>
</body>
</html>
