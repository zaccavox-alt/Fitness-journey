<!DOCTYPE html>
<html lang="en" data-theme="midnight">
<head>
  <meta charset="UTF-8" />
  <title>Our Fitness Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- PWA bits -->
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root {
      /* default (midnight) theme values */
      --bg-body-from: #1e293b;
      --bg-body-to: #020617;
      --bg-app: rgba(15, 23, 42, 0.96);
      --bg-card-from: rgba(30, 64, 175, 0.4);
      --bg-card-to: rgba(15, 23, 42, 0.96);

      --accent-1: #22c55e;
      --accent-2: #0ea5e9;

      --pill-bg: rgba(15, 118, 110, 0.1);
      --pill-border: rgba(45, 212, 191, 0.4);
      --pill-text: #6ee7b7;

      --border-strong: rgba(148, 163, 184, 0.4);
      --border-soft: rgba(148, 163, 184, 0.25);

      --danger-bg-hover: rgba(127, 29, 29, 0.9);
      --danger-border: rgba(248, 113, 113, 0.9);

      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;

      --chip-bg: rgba(15, 23, 42, 0.9);
      --card-inner-bg: rgba(15, 23, 42, 0.9);
      --table-header-bg: rgba(15, 23, 42, 0.98);
      --table-row-odd: rgba(15, 23, 42, 0.96);
      --table-row-even: rgba(15, 23, 42, 0.9);
    }

    /* Forest theme */
    :root[data-theme="forest"] {
      --bg-body-from: #022c22;
      --bg-body-to: #020617;
      --bg-card-from: rgba(22, 101, 52, 0.4);
      --bg-card-to: rgba(6, 78, 59, 0.96);

      --accent-1: #22c55e;
      --accent-2: #14b8a6;

      --pill-bg: rgba(21, 128, 61, 0.15);
      --pill-border: rgba(74, 222, 128, 0.5);
      --pill-text: #bbf7d0;

      --border-strong: rgba(52, 211, 153, 0.45);
      --border-soft: rgba(34, 197, 94, 0.25);

      --chip-bg: rgba(6, 78, 59, 0.95);
      --card-inner-bg: rgba(6, 78, 59, 0.95);
      --table-header-bg: rgba(6, 78, 59, 0.98);
      --table-row-odd: rgba(6, 78, 59, 0.96);
      --table-row-even: rgba(6, 78, 59, 0.9);
    }

    /* Sunset theme */
    :root[data-theme="sunset"] {
      --bg-body-from: #4c1d95;
      --bg-body-to: #020617;
      --bg-card-from: rgba(192, 38, 211, 0.35);
      --bg-card-to: rgba(76, 29, 149, 0.96);

      --accent-1: #fb7185;
      --accent-2: #f97316;

      --pill-bg: rgba(251, 113, 133, 0.16);
      --pill-border: rgba(249, 115, 22, 0.5);
      --pill-text: #fed7aa;

      --border-strong: rgba(216, 180, 254, 0.45);
      --border-soft: rgba(147, 51, 234, 0.25);

      --chip-bg: rgba(76, 29, 149, 0.95);
      --card-inner-bg: rgba(76, 29, 149, 0.95);
      --table-header-bg: rgba(76, 29, 149, 0.98);
      --table-row-odd: rgba(76, 29, 149, 0.96);
      --table-row-even: rgba(76, 29, 149, 0.9);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top left, var(--bg-body-from), var(--bg-body-to));
      color: var(--text-main);
      padding: 1rem;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: var(--bg-app);
      border-radius: 1.5rem;
      padding: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-soft);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--pill-text);
      font-size: 0.75rem;
      border: 1px solid var(--pill-border);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-1);
      box-shadow: 0 0 6px var(--accent-1);
    }

    .user-toggle {
      display: inline-flex;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 0.25rem;
      border: 1px solid var(--border-strong);
    }

    .user-toggle button {
      border: none;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      transition: all 0.16s ease-out;
      white-space: nowrap;
    }

    .user-toggle button.active {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #020617;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.7);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 1.25rem;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, var(--bg-card-from), var(--bg-card-to));
      border-radius: 1.25rem;
      padding: 1.1rem;
      border: 1px solid var(--border-strong);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .card small {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .goals-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.8rem;
      margin-bottom: 0.6rem;
      flex-wrap: wrap;
    }

    .goal-pill {
      flex: 1;
      min-width: 120px;
      background: var(--card-inner-bg);
      border-radius: 0.9rem;
      padding: 0.7rem 0.8rem;
      border: 1px solid var(--border-strong);
      font-size: 0.8rem;
    }

    .goal-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .goal-value {
      font-size: 0.95rem;
      margin-top: 0.15rem;
      font-weight: 600;
    }

    form {
      margin-top: 0.75rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem 0.75rem;
      font-size: 0.85rem;
    }

    @media (max-width: 600px) {
      form {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    input,
    textarea,
    select {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.4rem 0.65rem;
      color: var(--text-main);
      font-size: 0.85rem;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent-1);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }

    .form-full {
      grid-column: 1 / -1;
    }

    .btn-primary {
      grid-column: 1 / -1;
      margin-top: 0.3rem;
      padding: 0.55rem 0.8rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #020617;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.7);
    }

    .btn-small {
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .btn-small:hover {
      background: rgba(30, 64, 175, 0.8);
    }

    .btn-icon {
      border: none;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.85rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .btn-icon:hover {
      background: var(--danger-bg-hover);
      border-color: var(--danger-border);
    }

    .summary-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.8rem;
      flex-wrap: wrap;
    }

    .summary-heading {
      margin-top: 0.6rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .chip {
      background: var(--chip-bg);
      border-radius: 999px;
      padding: 0.25rem 0.7rem;
      font-size: 0.75rem;
      border: 1px solid var(--border-strong);
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-1);
    }

    .charts {
      margin-top: 0.7rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }

    @media (max-width: 800px) {
      .charts {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .chart-card {
      background: var(--card-inner-bg);
      border-radius: 0.9rem;
      border: 1px solid var(--border-strong);
      padding: 0.5rem 0.6rem 0.8rem;
    }

    .chart-card-title {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 160px;
    }

    .entries-list {
      margin-top: 0.7rem;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 0.9rem;
      border: 1px solid var(--border-strong);
      background: var(--card-inner-bg);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: var(--table-header-bg);
      z-index: 1;
    }

    th,
    td {
      padding: 0.45rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.75rem;
    }

    tbody tr:nth-child(odd) {
      background: var(--table-row-odd);
    }

    tbody tr:nth-child(even) {
      background: var(--table-row-even);
    }

    .note-cell {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .empty-state {
      padding: 0.8rem;
      text-align: center;
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    .badge-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    .badge {
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--border-strong);
      background: var(--chip-bg);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .badge.locked {
      opacity: 0.4;
      border-style: dashed;
    }

    .badge-icon {
      font-size: 0.85rem;
    }

    .badge-label {
      font-weight: 500;
    }

    /* Encouragement board */
    .encouragement {
      margin-top: 0.9rem;
      padding-top: 0.7rem;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .enc-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
    }

    .enc-header h3 {
      font-size: 0.95rem;
    }

    .enc-header small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    #encForm {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    #encForm textarea {
      min-height: 44px;
      max-height: 100px;
      font-size: 0.8rem;
    }

    #encForm button {
      align-self: flex-start;
      padding-inline: 0.9rem;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .enc-list {
      max-height: 140px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .enc-item {
      padding: 0.5rem 0.6rem;
      border-radius: 0.7rem;
      background: var(--card-inner-bg);
      border: 1px solid var(--border-strong);
    }

    .enc-meta {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.2rem;
    }

    .enc-text {
      font-size: 0.8rem;
      line-height: 1.3;
    }
  </style>

  <!-- Firebase (compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Our Fitness Journey</h1>
        <p class="subtitle">Log workouts, chase goals, and keep each other accountable. üíö</p>
      </div>
      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:0.35rem;">
        <div class="pill">
          <span class="pill-dot"></span>
          Shared Progress
        </div>
        <div class="user-toggle" id="userToggle">
          <button data-user="you" class="active">You</button>
          <button data-user="partner">Partner</button>
        </div>
        <div style="display:flex; gap:0.35rem; margin-top:0.2rem;">
          <button id="editNamesBtn" class="btn-small" type="button">
            ‚úèÔ∏è Names
          </button>
          <select id="themeSelect" class="btn-small" style="padding-right:1.5rem;">
            <option value="midnight">üåô Midnight</option>
            <option value="forest">üå≤ Forest</option>
            <option value="sunset">üåÖ Sunset</option>
          </select>
        </div>
      </div>
    </header>

    <div class="layout">
      <!-- Left: goals + log -->
      <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
          <div>
            <h2 id="goalsTitle">Weekly goals</h2>
            <small>Simple weekly targets you‚Äôre both aiming for.</small>
          </div>
          <button id="editGoalsBtn" class="btn-small" type="button">
            ‚úèÔ∏è Edit goals
          </button>
        </div>

        <div class="goals-row" id="goalsDisplay"></div>

        <form id="goalsForm" style="display:none; margin-bottom:0.6rem;">
          <label>
            Workouts / week
            <input type="number" min="0" id="goalWorkouts" placeholder="e.g. 4" />
          </label>
          <label>
            Active minutes / week
            <input type="number" min="0" id="goalMinutes" placeholder="e.g. 150" />
          </label>
          <button type="button" class="btn-primary" id="saveGoalsBtn">
            üíæ Save goals
          </button>
        </form>

        <hr style="border:none; border-top:1px solid rgba(31,41,55,0.9); margin:0.5rem 0 0.8rem;" />

        <div>
          <h2>Log today</h2>
          <small>Add your workout or activity for any day.</small>
        </div>

        <form id="logForm">
          <label>
            Date
            <input type="date" id="logDate" required />
          </label>

          <label>
            Workouts
            <input type="number" min="0" id="logWorkouts" placeholder="e.g. 1" />
          </label>

          <label>
            Active minutes
            <input type="number" min="0" id="logMinutes" placeholder="e.g. 45" />
          </label>

          <label>
            Steps (optional)
            <input type="number" min="0" id="logSteps" placeholder="e.g. 8000" />
          </label>

          <label class="form-full">
            Notes (how did it feel?)
            <textarea id="logNotes" placeholder="Felt strong, hit a new PR, went for a walk together..."></textarea>
          </label>

          <button type="submit" class="btn-primary">
            ‚ûï Add entry
          </button>
        </form>
      </section>

      <!-- Right: summary + charts + history + encouragement -->
      <section class="card">
        <div>
          <h2 id="summaryTitle">This week</h2>
          <small>Last 7 days for the selected person.</small>
        </div>

        <div class="summary-row" id="summaryChips"></div>

        <div class="summary-heading">Couple summary (last 7 days)</div>
        <div class="summary-row" id="coupleSummaryRow"></div>

        <div class="summary-heading" style="margin-top:0.6rem;">Streaks & badges</div>
        <div class="summary-row" id="streakRow"></div>
        <div class="badge-grid" id="badgeGrid"></div>

        <div class="charts">
          <div class="chart-card">
            <div class="chart-card-title">Workouts (last 7 days)</div>
            <div class="chart-wrapper">
              <canvas id="workoutsChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-card-title">Active minutes (last 7 days)</div>
            <div class="chart-wrapper">
              <canvas id="minutesChart"></canvas>
            </div>
          </div>
        </div>

        <div class="entries-list" id="entriesContainer"></div>

        <div class="encouragement">
          <div class="enc-header">
            <h3>Encouragement board</h3>
            <small>Leave little notes to cheer each other on.</small>
          </div>
          <form id="encForm">
            <textarea
              id="encText"
              placeholder="e.g. Proud of you for staying consistent this week ‚ù§Ô∏è"
            ></textarea>
            <button type="submit" class="btn-primary">
              üíå Add note
            </button>
          </form>
          <div class="enc-list" id="encList"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const APP_KEY = "couple_fitness_v1";
    const ROOM_KEY = "couple_fitness_room_id";

    // üîê Firebase config (yours)
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBftBxf5k7Nf0n2LnXUGNn2jK9clCejpuQ",
      authDomain: "fitness-journey-46e01.firebaseapp.com",
      projectId: "fitness-journey-46e01",
      storageBucket: "fitness-journey-46e01.firebasestorage.app",
      messagingSenderId: "308958691826",
      appId: "1:308958691826:web:1d785af1f576fe6272eb6b"
    };

    function initFirebase() {
      try {
        if (!window.firebase) return null;
        if (FIREBASE_CONFIG.apiKey.startsWith("PASTE_")) {
          console.warn("Firebase config not filled in yet ‚Äì running local-only.");
          return null;
        }
        const app = firebase.initializeApp(FIREBASE_CONFIG);
        return firebase.firestore();
      } catch (e) {
        console.error("Firebase init failed", e);
        return null;
      }
    }

    const db = initFirebase();
    let suppressRemote = false;

    const defaultState = {
      activeUser: "you",
      theme: "midnight",
      users: {
        you: {
          label: "You",
          goals: {
            workoutsPerWeek: 3,
            minutesPerWeek: 120,
          },
          entries: [],
        },
        partner: {
          label: "Partner",
          goals: {
            workoutsPerWeek: 3,
            minutesPerWeek: 120,
          },
          entries: [],
        },
      },
      messages: [],
    };

    function generateEntryId() {
      return (
        Date.now().toString(36) +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function ensureUserShape(stateObj, key, fallbackLabel) {
      if (!stateObj.users[key]) {
        stateObj.users[key] = {
          label: fallbackLabel,
          goals: { workoutsPerWeek: 3, minutesPerWeek: 120 },
          entries: [],
        };
      } else {
        const user = stateObj.users[key];
        if (typeof user.label !== "string" || !user.label.trim()) {
          user.label = fallbackLabel;
        }
        if (!user.goals) {
          user.goals = { workoutsPerWeek: 3, minutesPerWeek: 120 };
        }
        if (!Array.isArray(user.entries)) {
          user.entries = [];
        }
      }
    }

    function addMissingEntryIdsAndLabels(stateObj) {
      if (!stateObj.users) stateObj.users = {};
      if (!stateObj.theme) stateObj.theme = "midnight";

      ensureUserShape(stateObj, "you", "You");
      ensureUserShape(stateObj, "partner", "Partner");

      ["you", "partner"].forEach((key) => {
        const user = stateObj.users[key];
        user.entries.forEach((entry) => {
          if (!entry.id) {
            entry.id = generateEntryId();
          }
        });
      });

      if (!Array.isArray(stateObj.messages)) {
        stateObj.messages = [];
      }
    }

    function loadState() {
      try {
        const stored = localStorage.getItem(APP_KEY);
        if (!stored) {
          const clone = structuredClone(defaultState);
          addMissingEntryIdsAndLabels(clone);
          return clone;
        }
        const parsed = JSON.parse(stored);
        if (!parsed.users) parsed.users = {};
        if (!parsed.messages) parsed.messages = [];
        addMissingEntryIdsAndLabels(parsed);
        return parsed;
      } catch (e) {
        console.error("Failed to load state", e);
        const clone = structuredClone(defaultState);
        addMissingEntryIdsAndLabels(clone);
        return clone;
      }
    }

    let state = loadState();

    function getRoomId() {
      let roomId = localStorage.getItem(ROOM_KEY);
      if (roomId && roomId.trim()) return roomId.trim();

      roomId = window.prompt(
        "Enter a room code to sync with your partner (you both must use the same code):",
        "our-fitness-room"
      );
      if (!roomId) roomId = "default-room";
      roomId = roomId.trim();
      localStorage.setItem(ROOM_KEY, roomId);
      return roomId;
    }

    function saveState(localOnly = false) {
      localStorage.setItem(APP_KEY, JSON.stringify(state));
      if (localOnly || !db) return;

      const roomId = getRoomId();
      const docRef = db.collection("rooms").doc(roomId);
      const payload = {
        state: state,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };

      suppressRemote = true;
      docRef
        .set(payload)
        .catch((err) => {
          suppressRemote = false;
          console.error("Failed to sync to cloud", err);
        });
    }

    function setupRealtimeSync() {
      if (!db) return;
      const roomId = getRoomId();
      const docRef = db.collection("rooms").doc(roomId);

      docRef
        .get()
        .then((doc) => {
          if (doc.exists) {
            const data = doc.data();
            if (data && data.state) {
              state = data.state;
              addMissingEntryIdsAndLabels(state);
              saveState(true);
              applyTheme();
              renderAll();
            }
          } else {
            saveState(false);
          }
        })
        .catch((err) => console.error("Initial sync load failed", err));

      docRef.onSnapshot((snapshot) => {
        const data = snapshot.data();
        if (!data || !data.state) return;
        if (suppressRemote) {
          suppressRemote = false;
          return;
        }
        state = data.state;
        addMissingEntryIdsAndLabels(state);
        saveState(true);
        applyTheme();
        renderAll();
      });
    }

    function getActiveUserKey() {
      return state.activeUser || "you";
    }

    function getActiveUser() {
      return state.users[getActiveUserKey()];
    }

    function formatDate(dateStr) {
      const options = { month: "short", day: "numeric" };
      const d = new Date(dateStr + "T00:00:00");
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString(undefined, options);
    }

    function formatDateTimeShort(isoString) {
      const d = new Date(isoString);
      if (isNaN(d)) return "";
      const date = d.toLocaleDateString(undefined, {
        month: "short",
        day: "numeric",
      });
      const time = d.toLocaleTimeString(undefined, {
        hour: "numeric",
        minute: "2-digit",
      });
      return `${date}, ${time}`;
    }

    function applyTheme() {
      const theme = state.theme || "midnight";
      document.documentElement.setAttribute("data-theme", theme);
      const select = document.getElementById("themeSelect");
      if (select) {
        select.value = theme;
      }
    }

    function renderUserToggle() {
      const toggle = document.getElementById("userToggle");
      toggle.querySelectorAll("button").forEach((btn) => {
        const key = btn.getAttribute("data-user");
        const isActive = key === getActiveUserKey();
        btn.classList.toggle("active", isActive);
        const user = state.users[key];
        btn.textContent = user ? user.label : key;
      });
    }

    function renderGoals() {
      const user = getActiveUser();
      const container = document.getElementById("goalsDisplay");
      const goalsTitle = document.getElementById("goalsTitle");

      goalsTitle.textContent = `${user.label}'s weekly goals`;

      container.innerHTML = `
        <div class="goal-pill">
          <div class="goal-label">Workouts / week</div>
          <div class="goal-value">${user.goals.workoutsPerWeek || 0}</div>
        </div>
        <div class="goal-pill">
          <div class="goal-label">Active minutes / week</div>
          <div class="goal-value">${user.goals.minutesPerWeek || 0} min</div>
        </div>
      `;

      document.getElementById("goalWorkouts").value =
        user.goals.workoutsPerWeek ?? "";
      document.getElementById("goalMinutes").value =
        user.goals.minutesPerWeek ?? "";
    }

    function getLast7DayTotals(user) {
      const entries = user.entries || [];
      const now = new Date();
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(now.getDate() - 6);

      let totalWorkouts = 0;
      let totalMinutes = 0;
      let daysLogged = new Set();

      entries.forEach((entry) => {
        if (!entry.date) return;
        const d = new Date(entry.date + "T00:00:00");
        if (isNaN(d)) return;
        if (d >= sevenDaysAgo && d <= now) {
          totalWorkouts += Number(entry.workouts || 0);
          totalMinutes += Number(entry.minutes || 0);
          daysLogged.add(entry.date);
        }
      });

      return {
        workouts: totalWorkouts,
        minutes: totalMinutes,
        days: daysLogged.size,
      };
    }

    function getLast7DaySeries(user) {
      const entries = user.entries || [];
      const now = new Date();
      const days = [];

      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const key = `${yyyy}-${mm}-${dd}`;
        const label = d.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
        });
        days.push({ key, label });
      }

      const workouts = days.map((day) =>
        entries
          .filter((e) => e.date === day.key)
          .reduce((sum, e) => sum + Number(e.workouts || 0), 0)
      );

      const minutes = days.map((day) =>
        entries
          .filter((e) => e.date === day.key)
          .reduce((sum, e) => sum + Number(e.minutes || 0), 0)
      );

      return {
        labels: days.map((d) => d.label),
        workouts,
        minutes,
      };
    }

    function computeStreakInfo(dateSet) {
      if (!dateSet || dateSet.size === 0) {
        return { current: 0, best: 0 };
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const toKey = (d) => {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      };

      // Current streak: count backwards from today
      let current = 0;
      let cursor = new Date(today);
      while (true) {
        const key = toKey(cursor);
        if (dateSet.has(key)) {
          current++;
          cursor.setDate(cursor.getDate() - 1);
        } else {
          break;
        }
      }

      // Best streak: longest run in history
      const sortedDates = Array.from(dateSet)
        .map((s) => new Date(s + "T00:00:00"))
        .filter((d) => !isNaN(d))
        .sort((a, b) => a - b);

      let best = 0;
      let run = 0;
      let prev = null;

      for (const d of sortedDates) {
        if (!prev) {
          run = 1;
        } else {
          const diffDays = Math.round(
            (d - prev) / (1000 * 60 * 60 * 24)
          );
          if (diffDays === 1) {
            run++;
          } else {
            run = 1;
          }
        }
        if (run > best) best = run;
        prev = d;
      }

      return { current, best };
    }

    function getUserStats(user) {
      const entries = user.entries || [];
      const dateSet = new Set();
      let totalWorkouts = 0;
      let totalMinutes = 0;

      entries.forEach((e) => {
        if (!e.date) return;
        const key = e.date;
        dateSet.add(key);
        totalWorkouts += Number(e.workouts || 0);
        totalMinutes += Number(e.minutes || 0);
      });

      const streak = computeStreakInfo(dateSet);

      const now = new Date();
      const thirtyAgo = new Date(now);
      thirtyAgo.setDate(now.getDate() - 29);
      let activeDays30 = 0;

      dateSet.forEach((ds) => {
        const d = new Date(ds + "T00:00:00");
        if (!isNaN(d) && d >= thirtyAgo && d <= now) {
          activeDays30++;
        }
      });

      const last7 = getLast7DayTotals(user);

      return {
        totalWorkouts,
        totalMinutes,
        dateSet,
        streakCurrent: streak.current,
        streakBest: streak.best,
        activeDays30,
        last7,
      };
    }

    function getCoupleStreak(statsYou, statsPartner) {
      const both = new Set();
      statsYou.dateSet.forEach((d) => {
        if (statsPartner.dateSet.has(d)) {
          both.add(d);
        }
      });
      return computeStreakInfo(both);
    }

    const BADGE_DEFS = [
      {
        id: "first_workout",
        scope: "user",
        label: "First Step",
        icon: "‚≠ê",
        test: (stats) => stats.totalWorkouts >= 1,
      },
      {
        id: "three_day_streak",
        scope: "user",
        label: "3-Day Streak",
        icon: "üî•",
        test: (stats) => stats.streakBest >= 3,
      },
      {
        id: "seven_day_streak",
        scope: "user",
        label: "7-Day Streak",
        icon: "üèÖ",
        test: (stats) => stats.streakBest >= 7,
      },
      {
        id: "ten_workouts",
        scope: "user",
        label: "10 Workouts",
        icon: "üí™",
        test: (stats) => stats.totalWorkouts >= 10,
      },
      {
        id: "thousand_minutes",
        scope: "user",
        label: "1000 Minutes",
        icon: "‚è±Ô∏è",
        test: (stats) => stats.totalMinutes >= 1000,
      },
      {
        id: "couple_same_day",
        scope: "couple",
        label: "In Sync",
        icon: "‚ù§Ô∏è",
        test: (youStats, partnerStats) => {
          const now = new Date();
          const sevenAgo = new Date(now);
          sevenAgo.setDate(now.getDate() - 6);

          const inRange = (dateStr) => {
            const d = new Date(dateStr + "T00:00:00");
            return !isNaN(d) && d >= sevenAgo && d <= now;
          };

          const youSet = new Set();
          const partnerSet = new Set();

          youStats.dateSet.forEach((d) => {
            if (inRange(d)) youSet.add(d);
          });
          partnerStats.dateSet.forEach((d) => {
            if (inRange(d)) partnerSet.add(d);
          });

          let any = false;
          youSet.forEach((d) => {
            if (partnerSet.has(d)) any = true;
          });

          return any;
        },
      },
      {
        id: "couple_20_workouts",
        scope: "couple",
        label: "Tag Team 20",
        icon: "üëØ",
        test: (youStats, partnerStats) =>
          youStats.totalWorkouts + partnerStats.totalWorkouts >= 20,
      },
    ];

    function renderSummary() {
      const user = getActiveUser();
      const summaryTitle = document.getElementById("summaryTitle");
      summaryTitle.textContent = `${user.label}'s last 7 days`;

      const chipsContainer = document.getElementById("summaryChips");

      const activeTotals = getLast7DayTotals(user);
      const workoutsGoal = user.goals.workoutsPerWeek || 0;
      const minutesGoal = user.goals.minutesPerWeek || 0;

      chipsContainer.innerHTML = `
        <div class="chip">
          <span class="chip-dot"></span>
          ${activeTotals.workouts} / ${workoutsGoal} workouts
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          ${activeTotals.minutes} / ${minutesGoal} min
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          Logged on ${activeTotals.days} / 7 days
        </div>
      `;

      const coupleRow = document.getElementById("coupleSummaryRow");
      const youTotals = getLast7DayTotals(state.users.you);
      const partnerTotals = getLast7DayTotals(state.users.partner);
      const coupleWorkouts = youTotals.workouts + partnerTotals.workouts;
      const coupleMinutes = youTotals.minutes + partnerTotals.minutes;

      coupleRow.innerHTML = `
        <div class="chip">
          <span class="chip-dot"></span>
          ${state.users.you.label}: ${youTotals.workouts} w, ${youTotals.minutes} min
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          ${state.users.partner.label}: ${partnerTotals.workouts} w, ${partnerTotals.minutes} min
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          Together: ${coupleWorkouts} w, ${coupleMinutes} min
        </div>
      `;
    }

    function renderStreaksAndBadges() {
      const statsYou = getUserStats(state.users.you);
      const statsPartner = getUserStats(state.users.partner);
      const activeKey = getActiveUserKey();
      const activeStats =
        activeKey === "you" ? statsYou : statsPartner;
      const coupleStreak = getCoupleStreak(statsYou, statsPartner);

      const streakRow = document.getElementById("streakRow");
      const badgeGrid = document.getElementById("badgeGrid");

      // Streak chips
      streakRow.innerHTML = `
        <div class="chip">
          <span class="chip-dot"></span>
          Current streak: ${activeStats.streakCurrent} day${
        activeStats.streakCurrent === 1 ? "" : "s"
      }
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          Best streak: ${activeStats.streakBest} day${
        activeStats.streakBest === 1 ? "" : "s"
      }
        </div>
        <div class="chip">
          <span class="chip-dot"></span>
          Together streak: ${coupleStreak.best} day${
        coupleStreak.best === 1 ? "" : "s"
      }
        </div>
      `;

      // Badges for active user + couple
      const userBadges = BADGE_DEFS.filter((b) => b.scope === "user");
      const coupleBadges = BADGE_DEFS.filter(
        (b) => b.scope === "couple"
      );

      const badgeHtml = [];

      userBadges.forEach((b) => {
        const unlocked = b.test(activeStats);
        badgeHtml.push(
          `<div class="badge ${unlocked ? "" : "locked"}">
            <span class="badge-icon">${b.icon}</span>
            <span class="badge-label">${b.label}</span>
          </div>`
        );
      });

      coupleBadges.forEach((b) => {
        const unlocked = b.test(statsYou, statsPartner);
        badgeHtml.push(
          `<div class="badge ${unlocked ? "" : "locked"}">
            <span class="badge-icon">${b.icon}</span>
            <span class="badge-label">${b.label}</span>
          </div>`
        );
      });

      badgeGrid.innerHTML =
        badgeHtml.join("") ||
        `<div class="empty-state" style="padding:0.4rem 0; font-size:0.78rem;">
          Start logging to unlock badges together. üèÖ
        </div>`;
    }

    function renderEntries() {
      const user = getActiveUser();
      const container = document.getElementById("entriesContainer");
      const entries = [...(user.entries || [])];

      entries.sort((a, b) => {
        const da = new Date(a.date + "T00:00:00");
        const db = new Date(b.date + "T00:00:00");
        return db - da;
      });

      if (entries.length === 0) {
        container.innerHTML = `<div class="empty-state">
          No entries yet. Log your first workout and start your streak together. ‚ú®
        </div>`;
        return;
      }

      const rows = entries
        .map((e) => {
          const date = formatDate(e.date);
          const workouts = e.workouts || 0;
          const minutes = e.minutes || 0;
          const steps = e.steps ?? "";
          const notes = e.notes || "";
          const safeTitle = String(notes).replace(/"/g, "&quot;");
          return `
            <tr>
              <td>${date}</td>
              <td>${workouts}</td>
              <td>${minutes}</td>
              <td>${steps === null ? "" : steps}</td>
              <td class="note-cell" title="${safeTitle}">
                ${notes || "<span style='color:var(--text-soft);'>‚Äî</span>"}
              </td>
              <td style="text-align:right;">
                <button type="button" class="btn-icon" data-entry-id="${e.id}">
                  üóë
                </button>
              </td>
            </tr>
          `;
        })
        .join("");

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width:70px;">Date</th>
              <th style="width:60px;">Workouts</th>
              <th style="width:80px;">Minutes</th>
              <th style="width:80px;">Steps</th>
              <th>Notes</th>
              <th style="width:40px;"></th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    let workoutsChart = null;
    let minutesChart = null;

    function renderCharts() {
      const user = getActiveUser();
      const series = getLast7DaySeries(user);
      const workoutsCtx = document.getElementById("workoutsChart").getContext("2d");
      const minutesCtx = document.getElementById("minutesChart").getContext("2d");

      if (workoutsChart) workoutsChart.destroy();
      if (minutesChart) minutesChart.destroy();

      workoutsChart = new Chart(workoutsCtx, {
        type: "bar",
        data: {
          labels: series.labels,
          datasets: [{ label: "Workouts", data: series.workouts }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
            },
          },
          plugins: {
            legend: { display: false },
          },
        },
      });

      minutesChart = new Chart(minutesCtx, {
        type: "bar",
        data: {
          labels: series.labels,
          datasets: [{ label: "Minutes", data: series.minutes }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true },
          },
          plugins: {
            legend: { display: false },
          },
        },
      });
    }

    function renderEncouragement() {
      const listEl = document.getElementById("encList");
      const messages = [...(state.messages || [])];

      if (messages.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state" style="padding:0.5rem 0; font-size:0.78rem;">
            No notes yet. Leave a kind word for each other. üíå
          </div>
        `;
        return;
      }

      messages.sort((a, b) => {
        const da = new Date(a.createdAt);
        const db = new Date(b.createdAt);
        return db - da;
      });

      const items = messages
        .map((m) => {
          const user = state.users[m.author] || { label: m.author };
          const when = formatDateTimeShort(m.createdAt);
          const text = (m.text || "").trim();
          const safeText = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
          return `
            <div class="enc-item">
              <div class="enc-meta">
                <span>${user.label}</span>
                <span>${when}</span>
              </div>
              <div class="enc-text">${safeText}</div>
            </div>
          `;
        })
        .join("");

      listEl.innerHTML = items;
    }

    function renderAll() {
      applyTheme();
      renderUserToggle();
      renderGoals();
      renderSummary();
      renderStreaksAndBadges();
      renderEntries();
      renderCharts();
      renderEncouragement();
    }

    function setupUserToggle() {
      const toggle = document.getElementById("userToggle");
      toggle.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-user]");
        if (!btn) return;
        const userKey = btn.getAttribute("data-user");
        if (!state.users[userKey]) return;
        state.activeUser = userKey;
        saveState();
        renderAll();
      });
    }

    function setupGoalsEditing() {
      const editBtn = document.getElementById("editGoalsBtn");
      const goalsForm = document.getElementById("goalsForm");
      const saveBtn = document.getElementById("saveGoalsBtn");

      editBtn.addEventListener("click", () => {
        const visible = goalsForm.style.display === "grid";
        goalsForm.style.display = visible ? "none" : "grid";
      });

      saveBtn.addEventListener("click", () => {
        const workouts = Number(document.getElementById("goalWorkouts").value || 0);
        const minutes = Number(document.getElementById("goalMinutes").value || 0);

        const user = getActiveUser();
        user.goals.workoutsPerWeek = Math.max(0, Math.floor(workouts));
        user.goals.minutesPerWeek = Math.max(0, Math.floor(minutes));

        saveState();
        renderGoals();
        renderSummary();
        renderCharts();
      });
    }

    function setupLogForm() {
      const form = document.getElementById("logForm");
      const dateInput = document.getElementById("logDate");

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const date = dateInput.value;
        if (!date) return;

        const workouts = Number(document.getElementById("logWorkouts").value || 0);
        const minutes = Number(document.getElementById("logMinutes").value || 0);
        const stepsRaw = document.getElementById("logSteps").value.trim();
        const notes = document.getElementById("logNotes").value.trim();

        const user = getActiveUser();
        user.entries.push({
          id: generateEntryId(),
          date,
          workouts,
          minutes,
          steps: stepsRaw === "" ? null : Number(stepsRaw),
          notes,
        });

        saveState();
        renderSummary();
        renderEntries();
        renderCharts();

        document.getElementById("logWorkouts").value = "";
        document.getElementById("logMinutes").value = "";
        document.getElementById("logSteps").value = "";
        document.getElementById("logNotes").value = "";
      });
    }

    function setupDeleteHandler() {
      const container = document.getElementById("entriesContainer");
      container.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-entry-id]");
        if (!btn) return;
        const id = btn.getAttribute("data-entry-id");
        const user = getActiveUser();
        const idx = user.entries.findIndex((entry) => entry.id === id);
        if (idx === -1) return;

        const confirmed = window.confirm("Delete this entry?");
        if (!confirmed) return;

        user.entries.splice(idx, 1);
        saveState();
        renderSummary();
        renderEntries();
        renderCharts();
      });
    }

    function setupEncouragementForm() {
      const form = document.getElementById("encForm");
      const textarea = document.getElementById("encText");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = textarea.value.trim();
        if (!text) return;

        const authorKey = getActiveUserKey();
        state.messages.push({
          id: generateEntryId(),
          author: authorKey,
          text,
          createdAt: new Date().toISOString(),
        });

        saveState();
        textarea.value = "";
        renderEncouragement();
      });
    }

    function setupEditNames() {
      const btn = document.getElementById("editNamesBtn");
      btn.addEventListener("click", () => {
        const currentYou = state.users.you.label || "You";
        const currentPartner = state.users.partner.label || "Partner";

        const youName = window.prompt("Enter your name:", currentYou);
        if (youName !== null && youName.trim() !== "") {
          state.users.you.label = youName.trim();
        }

        const partnerName = window.prompt(
          "Enter your partner's name:",
          currentPartner
        );
        if (partnerName !== null && partnerName.trim() !== "") {
          state.users.partner.label = partnerName.trim();
        }

        saveState();
        renderAll();
      });
    }

    function setupThemeSelect() {
      const select = document.getElementById("themeSelect");
      if (!select) return;

      select.value = state.theme || "midnight";

      select.addEventListener("change", () => {
        const theme = select.value || "midnight";
        state.theme = theme;
        applyTheme();
        saveState();
      });
    }

    function setupServiceWorker() {
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("service-worker.js")
            .catch((err) => console.error("SW registration failed", err));
        });
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      applyTheme();
      setupUserToggle();
      setupGoalsEditing();
      setupLogForm();
      setupDeleteHandler();
      setupEncouragementForm();
      setupEditNames();
      setupThemeSelect();
      setupServiceWorker();
      renderAll();
      setupRealtimeSync();
    });
  </script>
</body>
</html>
